@using Frontend.Pages.Main
@using Frontend.Shared
@using Models
@using RichardSzalay.MockHttp
@inherits TestContext

@code {

    private async Task<MockHttpMessageHandler> Setup(bool isAuthorized) {
        var mockHttpHandler = Services.AddMockHttpClient();
        mockHttpHandler.When("/tag").RespondJson(new List<Tag>());
        mockHttpHandler.When("/wse/1/review/average").RespondJson(1);
        await MockAuthentication.AddMockAuthentication(this, mockHttpHandler, isAuthorized);
        var navMan = Services.GetRequiredService<FakeNavigationManager>();
        navMan.NavigateTo("http://localhost/");
        return mockHttpHandler;
    }

    [Fact]
    public async Task QueryTest() {
        var mock = await Setup(false);
        
        WebserviceEntry entry = new WebserviceEntry() {
            Name = "Google",
            ShortDescription = "A Search Engine",
            Link = "https://www.google.com/",
            ContactPersonId = 1,
            Id = 1,
            ViewCount = 1,
            CreatedAt = DateTimeOffset.UtcNow
        };
        IEnumerable<WebserviceEntry> list = new[] { entry };

        mock.When("search/wse").RespondJson(list);
        mock.When("search/wse/count").RespondJson(1);
        mock.When("search/wse?query=test").RespondJson(list);
        mock.When("search/wse/count?query=test").RespondJson(1);
        mock.When("http://localhost/wse/1/review/average").RespondJson(0);

        var cut = RenderComponent<Start>();
        var searchbar = cut.Find("input[type=search]");
        searchbar.Change("google");
        searchbar.TriggerEvent("onkeyup", new KeyboardEventArgs {
            Key = "Enter"
        });

        Assert.Equal("google", cut.Instance.Query);
    }

    [Fact]
    public async Task ShowWse() {
        await Setup(true);

        WebserviceEntry entry = new WebserviceEntry() {
            Name = "Google",
            ShortDescription = "A Search Engine",
            Link = "https://www.google.com/",
            ContactPersonId = 1,
            Id = 1,
            ViewCount = 1,
            CreatedAt = DateTimeOffset.UtcNow
        };

        IEnumerable<WebserviceEntry> list = new[] { entry };

        var cut = RenderComponent<WseSummaryList>(builder => builder.Add(p => p.Entries, list));
        Assert.Contains("Google", cut.Markup);
    }

}
